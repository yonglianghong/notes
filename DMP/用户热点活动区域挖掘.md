### 用户热点活动区域挖掘

##### 1. 项目目的

a) 通过百度api获取商圈和商家信息

b) 给用户打上热点活动区域商圈信息标签



##### 2. 技术方案

![用户热点活动区域挖掘技术方案](/Users/yonglianghong/Documents/Markdown/assets/用户热点活动区域挖掘技术方案.png)

1) 将原始用户日志按城市、聚类等方法筛选出用户热点活动区域及相应经纬度数据，将最终结果写入hive表，具体字段格式如下：

| 字段       | 类型                     | 说明                                                         |
| ---------- | ------------------------ | ------------------------------------------------------------ |
| combine_id | string                   | 用户id，即device_uuid或uv_u                                  |
| positions  | array&lt;string&gt;      | array里面一个元素代表一群点，点与点之间用';'分隔，一个点经度、维度之间用','分隔，比如："113.317287,23.119669;113.317027,23.119737" |
| geohashes  | map&lt;string,string&gt; | map里面key是geohash值,value为geohash区域对应的点，同上，点与点之间用分号分隔，经纬度之间用逗号分隔 |



2) 调用百度api，得到用户热点活动区域商家信息，每一条商家数据都包括具体的name、tag、street、经纬度等，以每条商家数据为一个doc，存入es，具体字段格式如下：

| 字段           | 类型      | 说明     |
| -------------- | --------- | -------- |
| country        | text      | 国家     |
| province       | text      | 省       |
| city           | text      | 市       |
| district       | text      | 县/区    |
| addr           | text      | 路       |
| name           | text      | 名字     |
| poiType        | text      | poi类型  |
| point          | geo_point | 经纬度   |
| tag            | text      | 标签     |
| poiRegionsName | text      | 商圈名字 |
| poiRegionsTag  | text      | 商圈标签 |



3) es里的商家数据支持geohash、具体地点、多边形等多种聚合方式，可以以此进一步挖掘商圈及对应商家信息，暂时有两条思路：

> a.第一步将用户活动地点聚类得到了一类热点活动区域，可以在区域内再确定一个核心点，以这个核心点为中心，去es里面请求半径1~3km以内的所有商家信息，以此得到用户热点活动的商圈信息以及可以进一步给用户打上商圈标签；

> b.第一步将用户活动地点聚类得到了热点区域的geohash值以及对应的点，按不同的geohash值，分别去es里面请求该geohash区域的所有商家信息，即得到了该geohash值所代表的商圈信息，再根据geohash值给用户打上商圈标签。



4) 将商圈信息生成标签并同时标记在用户上



##### 3.技术点

1）<u>Geohash精度问题</u>：***如何有效地请求百度地图api？***

***有效***分为两个方面：一是百度地图api调用次数的限制；一是用户活动的地点很多非常相近，可以预见请求百度地图api返回的结果非常相似（实际测试也是如此），于是考虑引入Geohash：

Geohash是对一块地理区域的编码，一个Geohash值代表的是一块矩形区域。对Geohash（base32编码）进行距离换算，6位大概是610米左右的精度，7位大概是76米左右的精度（精度可理解为一个正方形的边长）。

将用户热点活动区域的点转成Geohash值，再逆Geohash得到该Geohash区域的中心点的经纬度，用中心点去请求百度api，即可以得到周边商家信息（默认返回周边1000米内10个商家，初步猜测距离优先）。

由上，如果将Geohash控制到7位，便可以实现一次请求，几乎可以返回该Geohash区域内全部商家。



##### 4. 任务分工及排期

| 任务 |     负责人     |    排期     |
| :--: | :------------: | :---------: |
|  1   |     雍良洪     | 09.11~09.14 |
|  2   | 孙玉涛、雍良洪 | 09.17~09.19 |
|  3   | 雍良洪、孙玉涛 | 09.20~09.21 |
|  4   |      待定      |    待定     |



